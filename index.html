<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xpensive â€” Expense Tracker (Fixed)</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5224002796936482"
     crossorigin="anonymous"></script>
  <style>
    :root{
      --brand:#22c55e; --brand-dark:#16a34a; --bg:#f4f6f8; --card:#fff;
      --text:#111827; --muted:#6b7280; --danger:#ef4444; --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;padding:14px 16px;text-align:center;font-weight:700;font-size:20px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    main{max-width:920px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    .muted{color:var(--muted)}
    .hidden{display:none}
    /* auth */
    #authCard input, #authCard button {width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e6e6e6;font-size:15px}
    #authBtns{display:flex;gap:8px;margin-top:10px}
    #authBtns button{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}
    button.secondary{background:#f3f4f6;border:1px solid #e5e7eb}
    /* form */
    label{font-weight:600;margin-top:8px;display:block}
    input[type="date"], input[type="month"], select, input[type="number"], textarea{width:100%;height:42px;padding:8px 10px;border-radius:8px;border:1px solid #e6e6e6}
    textarea{height:80px;resize:vertical;padding:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .btn-row{display:flex;gap:10px}
    .small{font-size:13px;color:var(--muted)}
    /* table */
    .table-wrap{overflow-x:auto;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:720px}
    thead th{background:var(--brand);color:#fff;padding:12px;text-align:left}
    tbody td{padding:12px;border-top:1px solid #f1f5f9;vertical-align:middle;white-space:nowrap}
    tbody tr:nth-child(even){background:#fafafa}
    .btn-del{background:var(--danger);color:white;border:none;padding:7px 10px;border-radius:8px;cursor:pointer}
    .btn-del:hover{background:#d02323}
    .summary{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
    .big{font-weight:800;font-size:18px}
    .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;border:1px solid #e6e6e6}
    .right{text-align:right}
    .error{color:var(--danger);font-size:14px;margin-top:8px}
    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
      table{min-width:560px}
    }
  </style>
</head>
<body>
  <header>ðŸ’° Xpensive â€” Expense Tracker</header>
  <main><!-- AUTH Card -->
<section id="authCard" class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <div>
      <div style="font-size:18px;font-weight:700">Sign in or Create account</div>
      <div class="small muted">Use Email/Password to keep your expenses private.</div>
    </div>
    <div id="userInfo" class="hidden" style="text-align:right">
      <div class="small muted">Signed in as</div>
      <div id="userEmail" style="font-weight:700"></div>
      <div style="margin-top:8px"><button id="signOut" class="secondary">Sign out</button></div>
    </div>
  </div>

  <div id="authForms" style="margin-top:12px">
    <input id="nameField" type="text" placeholder="Full name (for signup)" />
    <input id="emailField" type="email" placeholder="Email" />
    <input id="passwordField" type="password" placeholder="Password (min 6 chars)" />
    <div id="authBtns">
      <button id="signInBtn" class="secondary">Sign in</button>
      <button id="signUpBtn" class="primary">Create account</button>
    </div>
    <div id="authError" class="error hidden"></div>
  </div>
</section>

<!-- APP: visible after auth -->
<section id="app" class="hidden">
  <!-- top: user + filters + totals -->
  <div class="card summary">
    <div style="display:flex;gap:10px;align-items:center;">
      <div>
        <div class="small muted">Logged in as</div>
        <div id="me" style="font-weight:800"></div>
      </div>
      <div class="chip"><button id="signOutBtn" class="secondary">Sign out</button></div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <label for="monthPicker" class="small muted" style="margin:0 8px 0 0">Month</label>
      <input id="monthPicker" type="month" />
      <label for="yearPicker" class="small muted" style="margin:0 8px 0 0">Year</label>
      <select id="yearPicker" class="chip"><option value="all">All years</option></select>
    </div>

    <div style="text-align:right">
      <div class="small muted">All-time total</div>
      <div id="allTimeTotal" class="big">â‚¹0</div>
    </div>
  </div>

  <!-- add expense -->
  <section class="card">
    <div class="grid">
      <div>
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label for="category">Category</label>
        <select id="category">
          <option value="" disabled selected>Select category</option>
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Shopping">Shopping</option>
          <option value="Bills">Bills</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div id="notesWrap" style="display:none">
        <label for="notes">Notes (required for "Other")</label>
        <textarea id="notes" placeholder="Describe the expense..."></textarea>
      </div>

      <div>
        <label for="amount">Amount (â‚¹)</label>
        <input id="amount" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00" />
      </div>

      <div style="grid-column:1 / -1">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="small muted">Selected view total</div>
          <div class="big right">â‚¹<span id="selectedTotal">0</span></div>
        </div>
        <div style="margin-top:10px">
          <button id="addBtn" class="primary">+ Add Expense</button>
        </div>
        <div id="appError" class="error hidden"></div>
      </div>
    </div>
  </section>

  <!-- table -->
  <section class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Date</th><th>Category</th><th>Amount</th><th>Notes</th><th>Action</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</section>

  </main>  <!-- Firebase (ESM v12) -->  <script type="module">
    /* ================== imports ================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ================ config (your project) ================ */
    const firebaseConfig = {
      apiKey: "AIzaSyD-0R_Sh_J8uCMV40W7qKYYFPH90gWum9U",
      authDomain: "expense-tracker-a611b.firebaseapp.com",
      projectId: "expense-tracker-a611b",
      storageBucket: "expense-tracker-a611b.firebasestorage.app",
      messagingSenderId: "481175764012",
      appId: "1:481175764012:web:5023598f4f1852aed62589",
      measurementId: "G-4XBWGDTX2K"
    };

    /* ================= init ================ */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ================ UI refs ================ */
    const authCard = document.getElementById("authCard");
    const authForms = document.getElementById("authForms");
    const authError = document.getElementById("authError");
    const userInfo = document.getElementById("userInfo");
    const userEmail = document.getElementById("userEmail");
    const signOutBtn = document.getElementById("signOutBtn");
    const signOutTop = document.getElementById("signOut");

    const nameField = document.getElementById("nameField");
    const emailField = document.getElementById("emailField");
    const passwordField = document.getElementById("passwordField");
    const signInBtn = document.getElementById("signInBtn");
    const signUpBtn = document.getElementById("signUpBtn");

    const appSection = document.getElementById("app");
    const me = document.getElementById("me");
    const dateEl = document.getElementById("date");
    const catEl = document.getElementById("category");
    const notesWrap = document.getElementById("notesWrap");
    const notesEl = document.getElementById("notes");
    const amtEl = document.getElementById("amount");
    const addBtn = document.getElementById("addBtn");
    const tbody = document.getElementById("tbody");
    const selectedTotalEl = document.getElementById("selectedTotal");
    const allTimeTotalEl = document.getElementById("allTimeTotal");
    const monthPicker = document.getElementById("monthPicker");
    const yearPicker = document.getElementById("yearPicker");
    const appError = document.getElementById("appError");

    // default date = today
    dateEl.value = new Date().toISOString().slice(0,10);

    // show notes when category Other
    catEl.addEventListener("change", () => {
      if (catEl.value === "Other") {
        notesWrap.style.display = "block";
        notesEl.setAttribute("required","required");
      } else {
        notesWrap.style.display = "none";
        notesEl.removeAttribute("required");
        notesEl.value = "";
      }
    });

    /* ================ friendly error messages ================ */
    function friendlyAuthError(err){
      // Firebase errors often have .code like 'auth/email-already-in-use'
      const code = (err && err.code) ? String(err.code) : (err && err.message ? String(err.message) : '');
      const m = String(code).match(/auth\/(.+)$/);
      const key = m ? m[1] : code;
      const map = {
        'email-already-in-use': 'That email is already registered. Try signing in or use another email.',
        'invalid-email': 'This email address looks invalid.',
        'user-not-found': 'No account found with that email.',
        'wrong-password': 'Incorrect password. Please try again.',
        'weak-password': 'Password should be at least 6 characters.',
        'popup-closed-by-user': 'Sign-in popup was closed. Try again.',
        'popup-blocked': 'Popup blocked by browser. Allow popups and try again.'
      };
      if (map[key]) return map[key];
      // fallback: try to clean the message a bit
      return (err && err.message) ? String(err.message).replace(/^Firebase:\s*/i, '') : 'An unexpected error occurred.';
    }

    /* ================ Auth handlers ================ */
    signUpBtn.addEventListener("click", async () => {
      authError.classList.add("hidden"); authError.textContent = "";
      const name = nameField.value.trim();
      const email = emailField.value.trim();
      const pwd = passwordField.value;
      if (!email || !pwd) { authError.textContent = "Email & password are required."; authError.classList.remove("hidden"); return; }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pwd);
        if (name) {
          await updateProfile(cred.user, { displayName: name });
        }
        // success â€” onAuthStateChanged will handle UI
      } catch (err) {
        authError.textContent = friendlyAuthError(err); authError.classList.remove("hidden");
      }
    });

    signInBtn.addEventListener("click", async () => {
      authError.classList.add("hidden"); authError.textContent = "";
      const email = emailField.value.trim();
      const pwd = passwordField.value;
      if (!email || !pwd) { authError.textContent = "Email & password are required."; authError.classList.remove("hidden"); return; }
      try {
        await signInWithEmailAndPassword(auth, email, pwd);
      } catch (err) {
        authError.textContent = friendlyAuthError(err); authError.classList.remove("hidden");
      }
    });

    signOutBtn.addEventListener("click", () => auth.signOut());
    signOutTop.addEventListener("click", () => auth.signOut());

    /* ================ State ================ */
    let currentUser = null;
    let unsubscribeExpenses = null;
    let allExpenses = [];

    function userExpensesRef(uid){ return collection(db, "users", uid, "expenses"); }
    function fmt(n){ return Number(n).toLocaleString(); }

    /* helper: normalize expense doc data so UI code doesn't break when Firestore has mixed types */
    function normalizeExpenseData(d){
      const out = Object.assign({}, d);
      // amount: ensure number
      if (typeof out.amount === 'string') out.amount = parseFloat(out.amount) || 0;
      if (typeof out.amount !== 'number') out.amount = Number(out.amount) || 0;

      // date: convert Firestore Timestamp -> YYYY-MM-DD string, or ensure string
      if (out.date && typeof out.date === 'object' && typeof out.date.toDate === 'function'){
        try { out.date = out.date.toDate().toISOString().slice(0,10); } catch(e){ out.date = '' }
      } else if (typeof out.date === 'number'){
        // epoch millis
        try { out.date = new Date(out.date).toISOString().slice(0,10); } catch(e){ out.date = '' }
      } else if (typeof out.date !== 'string'){
        out.date = out.date ? String(out.date) : '';
      }

      out.category = out.category || 'Other';
      out.notes = out.notes || '';
      out.uid = out.uid || '';
      return out;
    }

    /* ================ Auth state watcher ================ */
    onAuthStateChanged(auth, user => {
      currentUser = user;
      authError.classList.add("hidden"); authError.textContent = "";
      appError.classList.add("hidden"); appError.textContent = "";

      if (user) {
        // show app, hide auth card
        authCard.classList.add("hidden");
        appSection.classList.remove("hidden");
        userInfo.classList.remove("hidden");
        userEmail.textContent = user.email || user.displayName || "";
        me.textContent = user.displayName ? `${user.displayName} (${user.email})` : user.email;
        // start listening to user expenses
        startExpensesListener(user.uid);
      } else {
        // show auth card
        authCard.classList.remove("hidden");
        appSection.classList.add("hidden");
        userInfo.classList.add("hidden");
        userEmail.textContent = "";
        me.textContent = "";
        // detach listener
        if (unsubscribeExpenses) { unsubscribeExpenses(); unsubscribeExpenses = null; }
        allExpenses = [];
        renderFilteredData();
      }
    });

    /* ================ Listen user expenses (live) ================ */
    function startExpensesListener(uid){
      if (unsubscribeExpenses) unsubscribeExpenses();
      const q = query(userExpensesRef(uid), orderBy("date","desc"));
      unsubscribeExpenses = onSnapshot(q, snap => {
        allExpenses = [];
        snap.forEach(s => {
          const d = s.data();
          const norm = normalizeExpenseData(d);
          allExpenses.push({ id: s.id, ...norm });
        });
        populateYearPicker();
        renderFilteredData();
      }, err => {
        console.error("snapshot error", err);
        appError.textContent = "Failed to load expenses.";
        appError.classList.remove("hidden");
      });
    }

    /* ================ Add expense (per-user) ================ */
    addBtn.addEventListener("click", async () => {
      appError.classList.add("hidden"); appError.textContent = "";
      if (!currentUser) { appError.textContent = "Please sign in first."; appError.classList.remove("hidden"); return; }

      const date = dateEl.value; // YYYY-MM-DD
      const category = catEl.value;
      const amount = parseFloat(amtEl.value);
      const notes = (category === "Other") ? (notesEl.value || "").trim() : "";

      if (!date || !category || !amount || amount <= 0) {
        appError.textContent = "Please fill all fields correctly."; appError.classList.remove("hidden"); return;
      }
      if (category === "Other" && !notes) {
        appError.textContent = 'Please add a note for "Other" category.'; appError.classList.remove("hidden"); return;
      }

      try {
        addBtn.disabled = true; addBtn.textContent = 'Adding...';
        // store date explicitly as string (YYYY-MM-DD). This avoids mixed Timestamp/string issues.
        await addDoc(userExpensesRef(currentUser.uid), {
          uid: currentUser.uid,
          date: date,
          category, amount: Number(amount), notes
        });
        amtEl.value = ""; if (category === "Other") notesEl.value = "";
        amtEl.focus();
      } catch (err) {
        console.error(err);
        appError.textContent = "Failed to add expense. Try again.";
        appError.classList.remove("hidden");
      } finally {
        addBtn.disabled = false; addBtn.textContent = '+ Add Expense';
      }
    });

    /* ================ Delete per-user ================ */
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest(".btn-del");
      if (!btn) return;
      const id = btn.dataset.id;
      if (!id) return;
      if (!currentUser) { alert("Not signed in"); return; }
      if (!confirm("Delete this expense?")) return;
      try {
        await deleteDoc(doc(db, "users", currentUser.uid, "expenses", id));
      } catch (err) {
        console.error(err);
        alert("Delete failed");
      }
    });

    /* ================ Filtering & render ================ */
    function populateYearPicker(){
      const years = new Set();
      allExpenses.forEach(e => { if (e.date && typeof e.date === 'string' && e.date.length>=4) years.add(String(e.date).slice(0,4)); });
      const arr = Array.from(years).sort((a,b)=>b-a);
      const cur = yearPicker.value || "all";
      yearPicker.innerHTML = '<option value="all">All years</option>';
      arr.forEach(y => { const opt = document.createElement("option"); opt.value = y; opt.textContent = y; yearPicker.appendChild(opt); });
      // keep previous selection if possible
      if (arr.includes(cur)) yearPicker.value = cur; else yearPicker.value = (arr.length ? arr[0] : "all");
    }

    function renderFilteredData(){
      const monthVal = monthPicker.value; // YYYY-MM or empty
      const yearVal = yearPicker.value; // all or YYYY

      const filtered = allExpenses.filter(e => {
        if (!e.date) return false;
        if (monthVal) return String(e.date).startsWith(monthVal);
        if (yearVal && yearVal !== "all") return String(e.date).startsWith(yearVal);
        return true;
      });

      // sort by date desc (strings in YYYY-MM-DD sort correctly)
      filtered.sort((a,b) => (b.date||'').localeCompare(a.date||''));

      // render rows
      tbody.innerHTML = "";
      filtered.forEach(e => {
        const notesText = e.notes && e.notes.trim() ? e.notes : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${e.date || "-"}</td>
          <td>${e.category || "-"}</td>
          <td>â‚¹${fmt(e.amount)}</td>
          <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${notesText}</td>
          <td><button class="btn-del" data-id="${e.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      const selTotal = filtered.reduce((s,x)=>s + (Number(x.amount)||0), 0);
      selectedTotalEl.textContent = fmt(selTotal);

      const allTotal = allExpenses.reduce((s,x)=>s + (Number(x.amount)||0), 0);
      allTimeTotalEl.textContent = fmt(allTotal);
    }

    // filters events
    monthPicker.addEventListener("change", () => {
      if (monthPicker.value) yearPicker.value = monthPicker.value.slice(0,4);
      renderFilteredData();
    });
    yearPicker.addEventListener("change", () => {
      // when year changed we reset month (you can change behavior if you want month+year selection)
      monthPicker.value = "";
      renderFilteredData();
    });

    // initial empty render
    renderFilteredData();

    /* ================ End ================ */
  </script></body>
  </html>
